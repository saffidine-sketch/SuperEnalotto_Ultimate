<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperEnalotto Analyzer PRO - Dynamic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        body {
            background: #020617;
            color: #34d399;
            padding: 20px;
            line-height: 1.5;
        }

        .terminal {
            max-width: 1000px;
            margin: 0 auto;
            border: 1px solid #1e293b;
            background: #0f172a;
            padding: 20px;
            box-shadow: 0 0 20px rgba(52, 211, 153, 0.1);
        }

        h1 {
            font-size: 1.5rem;
            text-align: center;
            margin-bottom: 20px;
            color: #f8fafc;
            border-bottom: 1px solid #1e293b;
            padding-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            background: #1e293b;
            border: 1px solid #334155;
            color: #34d399;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            background: #334155;
            color: #f8fafc;
            transform: translateY(-2px);
        }

        .recent-indicator {
            display: inline-block;
            padding: 2px 8px;
            background: #dc2626;
            color: white;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 5px;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .update-panel {
            background: #1e293b;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            border-left: 4px solid #dc2626;
        }

        .update-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-top: 10px;
        }

        .update-form input {
            background: #020617;
            border: 1px solid #334155;
            color: #10b981;
            padding: 8px;
            border-radius: 4px;
        }

        .update-form button {
            min-width: auto;
            background: #dc2626;
            border-color: #dc2626;
            color: white;
        }

        textarea {
            width: 100%;
            height: 150px;
            background: #020617;
            border: 1px solid #1e293b;
            color: #10b981;
            padding: 10px;
            font-size: 0.9rem;
            margin-bottom: 20px;
            outline: none;
            font-family: inherit;
        }

        .config-panel {
            background: #1e293b;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .slider-group {
            margin: 10px 0;
        }

        .slider-group label {
            display: block;
            margin-bottom: 5px;
            color: #94a3b8;
        }

        input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }

        .recent-weight-group {
            background: #dc2626;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .strategies-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .strategy-btn {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            background: #1e293b;
            border: 1px solid #334155;
            color: #94a3b8;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .strategy-btn.active {
            border-color: #34d399;
            color: #34d399;
            background: #1e3a5c;
        }

        .results {
            border: 1px dashed #334155;
            padding: 20px;
            display: none;
            margin-top: 20px;
        }

        .strategy-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #334155;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .strategy-section.updated {
            border-color: #dc2626;
            background: rgba(220, 38, 38, 0.05);
            animation: highlight 1s ease-in-out;
        }

        @keyframes highlight {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #334155;
        }

        .strategy-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #f8fafc;
        }

        .strategy-desc {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .balls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .ball {
            width: 45px;
            height: 45px;
            background: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            transition: all 0.3s;
            position: relative;
        }

        .ball.new {
            animation: newBall 2s ease-in-out;
            box-shadow: 0 0 15px #dc2626;
        }

        @keyframes newBall {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .ball.system {
            background: #fbbf24;
            color: #020617;
            border: 2px solid #f59e0b;
            font-size: 0.9rem;
        }

        .combination-row {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 10px 0;
            padding: 10px;
            background: #1e293b;
            border-radius: 5px;
            align-items: center;
        }

        .combination-row .ball {
            width: 35px;
            height: 35px;
            font-size: 0.85rem;
        }

        .combination-label {
            min-width: 80px;
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .system-summary {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #fbbf24;
        }

        .system-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .system-stat {
            background: #0f172a;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border-left: 3px solid #10b981;
        }

        .system-stat-value {
            font-size: 1.8rem;
            color: #10b981;
            font-weight: bold;
        }

        .system-stat-label {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 5px;
        }

        .guarantee-badge {
            display: inline-block;
            padding: 5px 15px;
            background: #10b981;
            color: white;
            border-radius: 20px;
            font-weight: bold;
            margin: 0 5px;
        }

        .info-box {
            background: #1e3a5c;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .info-box h4 {
            color: #60a5fa;
            margin-bottom: 10px;
        }

        .ball.star {
            background: #eab308;
            color: #020617;
            border: 2px solid #fef08a;
        }

        .super-system-card {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            border: 2px solid #a855f7;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 0 25px rgba(168, 85, 247, 0.2);
        }

        .strategy-pool {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .strategy-pool-card {
            background: #0f172a;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid;
        }

        .mega-stat {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            border-radius: 15px;
            margin: 25px 0;
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.3);
        }

        .mega-stat-value {
            font-size: 3rem;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .mega-stat-label {
            font-size: 1rem;
            color: #e9d5ff;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: #0f172a;
            border-radius: 10px;
            overflow: hidden;
        }

        .comparison-table th {
            background: #7c3aed;
            color: white;
            padding: 15px;
            text-align: left;
        }

        .comparison-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #1e293b;
            color: #94a3b8;
        }

        .comparison-table tr:hover {
            background: #1e293b;
        }

        .winner-badge {
            display: inline-block;
            padding: 5px 15px;
            background: #10b981;
            color: white;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .warning-box {
            background: #7f1d1d;
            border-left: 4px solid #dc2626;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .warning-box h4 {
            color: #fca5a5;
            margin-bottom: 10px;
        }

        .warning-box p {
            color: #fecaca;
            line-height: 1.6;
        }

        .recency-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc2626;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1s infinite;
        }

        .comparison {
            margin-top: 15px;
            padding: 10px;
            background: #1e293b;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .comparison .added {
            color: #10b981;
        }

        .comparison .removed {
            color: #ef4444;
        }

        .validation-info {
            background: #065f46;
            color: #d1fae5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #10b981;
        }

        .validation-error {
            background: #7f1d1d;
            color: #fecaca;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #ef4444;
        }

        #loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .spinner {
            border: 2px solid #334155;
            border-top: 2px solid #34d399;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .label {
            color: #94a3b8;
            font-size: 0.9rem;
            margin: 15px 0 10px 0;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="terminal">
    <h1>> ANALYZER_PRO_v5.0_DYNAMIC <span class="recent-indicator">ESTRAZIONI RECENTI</span></h1>

    <div class="update-panel">
        <strong>üîÑ AGGIORNAMENTO LIVE</strong>
        <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 5px;">
            Aggiungi l'ultima estrazione per vedere cambiamenti immediati
        </div>
        <div class="update-form">
            <input type="text" id="newExtraction" placeholder="Es: 5,12,23,45,67,89,10 (6 num + SS)" />
            <button onclick="addNewExtraction()">AGGIUNGI ESTRAZIONE</button>
        </div>
    </div>

    <div class="controls">
        <input type="file" id="fileInput" style="display:none" accept=".txt,.csv">
        <button onclick="document.getElementById('fileInput').click()">[ CARICA_ARCHIVIO ]</button>
        <button onclick="analyzeAllStrategies()" style="color: #f8fafc; border-color: #34d399;">[ ANALISI_COMPLETA ]</button>
        <button onclick="showSystemsGenerator()" style="color: #fbbf24; border-color: #fbbf24;">[ SISTEMI_RIDOTTI ]</button>
        <button onclick="showSuperSystem()" style="color: #a855f7; border-color: #a855f7;">[ SUPER_SISTEMA ]</button>
        <button onclick="clearData()" style="color: #ef4444; border-color: #ef4444;">[ RESET ]</button>
    </div>

    <div class="config-panel">
        <div class="slider-group">
            <label>PESO FREQUENZA BASE: <span id="freqValue">50%</span></label>
            <input type="range" id="freqWeight" min="0" max="100" value="50">
        </div>
        <div class="slider-group">
            <label>PESO RITARDO BASE: <span id="delayValue">30%</span></label>
            <input type="range" id="delayWeight" min="0" max="100" value="30">
        </div>
        <div class="recent-weight-group">
            <label>PESO ESTRAZIONI RECENTI (ultime 10): <span id="recentValue">20%</span></label>
            <input type="range" id="recentWeight" min="0" max="100" value="20">
            <div style="font-size: 0.7rem; color: #fecaca;">
                Pi√π alto = maggiore influenza delle nuove estrazioni
            </div>
        </div>
    </div>

    <div class="strategies-panel">
        <div class="strategy-btn active" onclick="selectStrategy('balanced')">
            <div>‚öñÔ∏è BILANCIATA</div>
            <div class="strategy-desc">Equilibrio perfetto</div>
        </div>
        <div class="strategy-btn" onclick="selectStrategy('recentFocused')">
            <div>üéØ FOCUS RECENTI</div>
            <div class="strategy-desc">Ultime estrazioni</div>
        </div>
        <div class="strategy-btn" onclick="selectStrategy('hotNumbers')">
            <div>üî• NUMERI CALDI</div>
            <div class="strategy-desc">I pi√π frequenti</div>
        </div>
        <div class="strategy-btn" onclick="selectStrategy('coldNumbers')">
            <div>‚ùÑÔ∏è RITARDATARI</div>
            <div class="strategy-desc">Massimo ritardo</div>
        </div>
        <div class="strategy-btn" onclick="selectStrategy('contrarian')">
            <div>üîÑ CONTRARIAN</div>
            <div class="strategy-desc">Anti-popolare</div>
        </div>
        <div class="strategy-btn" onclick="selectStrategy('mathematical')">
            <div>üìê MATEMATICA</div>
            <div class="strategy-desc">Distribuzione uniforme</div>
        </div>
    </div>

    <textarea id="dataInput" placeholder="Archivio caricato apparir√† qui..."></textarea>

    <div id="validationInfo"></div>

    <div id="loading">
        <div class="spinner"></div>
        <div style="margin-top: 10px; color: #94a3b8;">ANALISI IN CORSO...</div>
    </div>

    <div id="results" class="results">
        <div id="updateInfo" style="margin-bottom: 20px;"></div>
        <div id="strategyResults"></div>
        <div id="log" style="font-size: 0.7rem; color: #475569; margin-top: 20px; text-align: left;"></div>
    </div>

    <div id="systemsPanel" class="results" style="display: none;">
        <h2 style="color: #fbbf24; margin-bottom: 20px; text-align: center;">
            üéØ GENERATORE SISTEMI RIDOTTI
        </h2>

        <div style="background: #1e293b; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #fbbf24;">
            <h3 style="color: #f8fafc; margin-bottom: 15px;">üìö Cosa sono i Sistemi Ridotti?</h3>
            <p style="color: #94a3b8; line-height: 1.8; margin-bottom: 15px;">
                Un <strong>Sistema Ridotto</strong> √® l'UNICO modo matematicamente valido di aumentare le tue chance.
                Invece di giocare 1 sestina, ne giochi multiple in modo intelligente.
            </p>
            <div style="background: #0f172a; padding: 15px; border-radius: 5px; border-left: 3px solid #10b981;">
                <strong style="color: #10b981;">‚úì GARANZIA MATEMATICA:</strong><br>
                <span style="color: #d1fae5;">
                Se tra i tuoi N numeri ci sono 6 numeri vincenti, hai la GARANZIA di fare almeno un certo premio (3, 4 o 5).
                </span>
            </div>
        </div>

        <div class="config-panel">
            <h3 style="color: #f8fafc; margin-bottom: 15px;">‚öôÔ∏è Configurazione Sistema</h3>

            <div class="slider-group">
                <label>NUMERI DA GIOCARE: <span id="systemNumbersValue">9</span></label>
                <input type="range" id="systemNumbers" min="7" max="15" value="9">
                <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 5px;">
                    Pi√π numeri = pi√π combinazioni = costo maggiore ma garanzie migliori
                </div>
            </div>

            <div class="slider-group" style="margin-top: 20px;">
                <label>GARANZIA MINIMA:</label>
                <select id="systemGuarantee" style="width: 100%; padding: 8px; background: #020617; border: 1px solid #334155; color: #10b981; border-radius: 4px;">
                    <option value="3">Garanzia 3 (economico, molte combinazioni)</option>
                    <option value="4" selected>Garanzia 4 (bilanciato)</option>
                    <option value="5">Garanzia 5 (costoso, poche combinazioni)</option>
                </select>
                <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 5px;">
                    Se indovini 6/6 tra i tuoi numeri, FAI ALMENO questo premio
                </div>
            </div>

            <div style="margin-top: 20px;">
                <label style="color: #94a3b8; margin-bottom: 10px; display: block;">FONTE NUMERI:</label>
                <select id="systemSource" style="width: 100%; padding: 8px; background: #020617; border: 1px solid #334155; color: #10b981; border-radius: 4px;">
                    <option value="balanced">Strategia Bilanciata</option>
                    <option value="hotNumbers">Numeri Caldi</option>
                    <option value="coldNumbers">Numeri Ritardatari</option>
                    <option value="mathematical">Distribuzione Matematica</option>
                    <option value="contrarian">Strategia Contrarian</option>
                    <option value="mixed">Mix Intelligente (consigliato)</option>
                </select>
            </div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button onclick="generateReducedSystem()" style="padding: 15px 40px; font-size: 1.1rem; background: #fbbf24; color: #020617; border: 2px solid #f59e0b;">
                üé≤ GENERA SISTEMA RIDOTTO
            </button>
        </div>

        <div id="systemResults"></div>
    </div>

    <div id="superSystemPanel" class="results" style="display: none;">
        <h2 style="color: #a855f7; margin-bottom: 20px; text-align: center; font-size: 2rem;">
            ‚ö° SUPER SISTEMA - COPERTURA MASSIMA
        </h2>

        <div style="background: linear-gradient(135deg, #581c87 0%, #7c3aed 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 3px solid #a855f7; box-shadow: 0 0 30px rgba(168, 85, 247, 0.3);">
            <h3 style="color: #fff; margin-bottom: 20px; text-align: center; font-size: 1.4rem;">
                üéØ IL SISTEMA PI√ô POTENTE
            </h3>
            <p style="color: #e9d5ff; line-height: 1.8; margin-bottom: 15px; font-size: 1.05rem;">
                Il <strong>SUPER SISTEMA</strong> combina MULTIPLE strategie in un unico mega-sistema.
                Invece di scegliere UNA strategia, le giochi TUTTE contemporaneamente con riduzione intelligente!
            </p>
            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; border-left: 4px solid #10b981;">
                <strong style="color: #10b981; font-size: 1.1rem;">‚úì VANTAGGI:</strong><br>
                <span style="color: #d1fae5; line-height: 2;">
                ‚Ä¢ Copri TUTTE le filosofie (caldi, freddi, bilanciati, matematici)<br>
                ‚Ä¢ Riduzione automatica delle combinazioni duplicate<br>
                ‚Ä¢ Massimizza la diversificazione<br>
                ‚Ä¢ Se una strategia "azzecca", sei coperto!
                </span>
            </div>
        </div>

        <div class="config-panel" style="border: 2px solid #a855f7;">
            <h3 style="color: #a855f7; margin-bottom: 20px;">‚öôÔ∏è Configurazione Super Sistema</h3>

            <div class="slider-group">
                <label>BUDGET TOTALE: <span id="superBudgetValue">50‚Ç¨</span></label>
                <input type="range" id="superBudget" min="20" max="200" value="50" step="10">
                <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 5px;">
                    Il sistema ottimizzer√† il numero di combinazioni in base al tuo budget
                </div>
            </div>

            <div style="margin-top: 25px; background: #0f172a; padding: 20px; border-radius: 10px;">
                <label style="color: #a855f7; display: block; margin-bottom: 15px; font-weight: bold;">
                    üé® STRATEGIE DA INCLUDERE (seleziona almeno 2):
                </label>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <label style="display: flex; align-items: center; color: #94a3b8; cursor: pointer; padding: 10px; background: #1e293b; border-radius: 5px; transition: all 0.3s;">
                        <input type="checkbox" id="includeCaldi" checked style="margin-right: 10px; width: 18px; height: 18px;">
                        üî• Numeri Caldi
                    </label>
                    <label style="display: flex; align-items: center; color: #94a3b8; cursor: pointer; padding: 10px; background: #1e293b; border-radius: 5px;">
                        <input type="checkbox" id="includeFreddi" checked style="margin-right: 10px; width: 18px; height: 18px;">
                        ‚ùÑÔ∏è Ritardatari
                    </label>
                    <label style="display: flex; align-items: center; color: #94a3b8; cursor: pointer; padding: 10px; background: #1e293b; border-radius: 5px;">
                        <input type="checkbox" id="includeBalanced" checked style="margin-right: 10px; width: 18px; height: 18px;">
                        ‚öñÔ∏è Bilanciata
                    </label>
                    <label style="display: flex; align-items: center; color: #94a3b8; cursor: pointer; padding: 10px; background: #1e293b; border-radius: 5px;">
                        <input type="checkbox" id="includeRecent" checked style="margin-right: 10px; width: 18px; height: 18px;">
                        üéØ Focus Recenti
                    </label>
                    <label style="display: flex; align-items: center; color: #94a3b8; cursor: pointer; padding: 10px; background: #1e293b; border-radius: 5px;">
                        <input type="checkbox" id="includeContrarian" style="margin-right: 10px; width: 18px; height: 18px;">
                        üîÑ Contrarian
                    </label>
                    <label style="display: flex; align-items: center; color: #94a3b8; cursor: pointer; padding: 10px; background: #1e293b; border-radius: 5px;">
                        <input type="checkbox" id="includeMath" style="margin-right: 10px; width: 18px; height: 18px;">
                        üìê Matematica
                    </label>
                </div>
            </div>

            <div style="margin-top: 25px;">
                <label style="color: #a855f7; display: block; margin-bottom: 10px; font-weight: bold;">
                    üé≤ MODALIT√Ä SUPER SISTEMA:
                </label>
                <select id="superMode" style="width: 100%; padding: 12px; background: #020617; border: 2px solid #a855f7; color: #e9d5ff; border-radius: 8px; font-size: 1rem;">
                    <option value="union">üåü UNION (Unione) - Max copertura, nessun duplicato</option>
                    <option value="intersection">üéØ INTERSECTION (Intersezione) - Solo numeri comuni</option>
                    <option value="hybrid">‚ö° HYBRID (Ibrido) - Mix intelligente</option>
                    <option value="megasystem">üöÄ MEGASYSTEM - Tutte le combinazioni</option>
                </select>
                <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 8px; line-height: 1.6;">
                    <strong>Union:</strong> Prende i migliori numeri da ogni strategia (pi√π diversificato)<br>
                    <strong>Intersection:</strong> Solo numeri che appaiono in pi√π strategie (pi√π concentrato)<br>
                    <strong>Hybrid:</strong> 50% union + 50% intersection (equilibrato)<br>
                    <strong>Megasystem:</strong> Gioca tutte le sestine delle strategie selezionate
                </div>
            </div>
        </div>

        <div style="text-align: center; margin: 35px 0;">
            <button onclick="generateSuperSystem()" style="padding: 20px 50px; font-size: 1.3rem; background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%); color: white; border: 3px solid #c084fc; border-radius: 15px; box-shadow: 0 0 20px rgba(168, 85, 247, 0.5); cursor: pointer; font-weight: bold; transition: all 0.3s;">
                ‚ö° GENERA SUPER SISTEMA ‚ö°
            </button>
        </div>

        <div id="superSystemResults"></div>
    </div>
</div>

<script>
    // ===============================
    // VARIABILI GLOBALI
    // ===============================
    let currentStrategy = 'balanced';
    let analysisData = null;
    let previousResults = null;
    let recentExtractions = [];

    const strategies = {
        'balanced': {
            name: 'Bilanciata con Influenza Recente',
            desc: 'Equilibrio con maggior peso alle estrazioni recenti',
            freqWeight: 0.5,
            delayWeight: 0.3,
            recentWeight: 0.2,
            color: '#34d399'
        },
        'recentFocused': {
            name: 'Focus Estrazioni Recenti',
            desc: 'Massima enfasi sulle nuove estrazioni',
            freqWeight: 0.3,
            delayWeight: 0.2,
            recentWeight: 0.5,
            color: '#dc2626'
        },
        'hotNumbers': {
            name: 'Cacciatore di Numeri Caldi',
            desc: 'Solo i pi√π frequenti in assoluto',
            freqWeight: 0.9,
            delayWeight: 0.05,
            recentWeight: 0.05,
            color: '#f59e0b'
        },
        'coldNumbers': {
            name: 'Cacciatore di Ritardatari',
            desc: 'Solo i numeri con maggior ritardo',
            freqWeight: 0.1,
            delayWeight: 0.8,
            recentWeight: 0.1,
            color: '#06b6d4'
        },
        'contrarian': {
            name: 'Strategia Contrarian',
            desc: 'Evita i numeri pi√π giocati e frequenti',
            freqWeight: -0.3,
            delayWeight: 0.6,
            recentWeight: 0.1,
            color: '#8b5cf6',
            inverted: true
        },
        'mathematical': {
            name: 'Distribuzione Matematica',
            desc: 'Copre uniformemente tutto il range 1-90',
            freqWeight: 0.3,
            delayWeight: 0.3,
            recentWeight: 0.1,
            color: '#ec4899',
            special: 'spread'
        }
    };

    // Configurazione slider
    document.getElementById('freqWeight').addEventListener('input', function() {
        strategies.balanced.freqWeight = this.value / 100;
        document.getElementById('freqValue').textContent = this.value + '%';
    });

    document.getElementById('delayWeight').addEventListener('input', function() {
        strategies.balanced.delayWeight = this.value / 100;
        document.getElementById('delayValue').textContent = this.value + '%';
    });

    document.getElementById('recentWeight').addEventListener('input', function() {
        strategies.balanced.recentWeight = this.value / 100;
        document.getElementById('recentValue').textContent = this.value + '%';
    });

    document.getElementById('systemNumbers').addEventListener('input', function() {
        document.getElementById('systemNumbersValue').textContent = this.value;
    });

    function showSystemsGenerator() {
        if (!analysisData) {
            alert("Prima carica l'archivio e fai un'analisi!");
            return;
        }
        document.getElementById('results').style.display = 'none';
        document.getElementById('systemsPanel').style.display = 'block';
        window.scrollTo({top: document.getElementById('systemsPanel').offsetTop - 20, behavior: 'smooth'});
    }

    // Database sistemi ridotti ottimizzati
    const reducedSystems = {
        7: {
            3: [[1,2,3,4,5,6], [1,2,3,4,5,7], [1,2,3,4,6,7], [1,2,3,5,6,7], [1,2,4,5,6,7], [1,3,4,5,6,7], [2,3,4,5,6,7]],
            4: [[1,2,3,4,5,6], [1,2,3,4,5,7], [1,2,3,4,6,7], [1,3,4,5,6,7]],
            5: [[1,2,3,4,5,6], [1,2,3,4,5,7]]
        },
        8: {
            3: [[1,2,3,4,5,6], [1,2,3,4,7,8], [1,2,5,6,7,8], [1,3,4,5,7,8], [1,3,4,6,7,8], [2,3,5,6,7,8], [2,4,5,6,7,8]],
            4: [[1,2,3,4,5,6], [1,2,3,7,8,4], [1,5,6,7,8,2], [3,4,5,6,7,8]],
            5: [[1,2,3,4,5,6], [1,2,3,7,8,4], [1,7,8,5,6,2]]
        },
        9: {
            3: [[1,2,3,4,5,6], [1,2,3,7,8,9], [1,4,5,7,8,9], [1,4,6,7,8,9], [2,4,5,6,7,8], [2,4,5,6,7,9], [3,5,6,7,8,9]],
            4: [[1,2,3,4,5,6], [1,2,7,8,9,3], [1,4,5,6,7,8], [1,4,5,6,7,9], [2,4,5,7,8,9], [3,6,7,8,9,4]],
            5: [[1,2,3,4,5,6], [1,2,3,7,8,9], [1,4,5,7,8,6], [2,4,6,7,8,9]]
        },
        10: {
            3: [[1,2,3,4,5,6], [1,2,3,7,8,9], [1,2,4,7,9,10], [1,3,5,7,8,10], [1,4,6,8,9,10], [2,3,6,7,9,10], [2,4,5,8,9,10], [3,4,5,6,8,10], [5,6,7,9,10,2]],
            4: [[1,2,3,4,5,6], [1,2,7,8,9,10], [1,3,4,7,8,9], [1,5,6,7,9,10], [2,4,5,6,8,10], [2,4,7,8,9,10], [3,5,6,8,9,10]],
            5: [[1,2,3,4,5,6], [1,2,3,7,8,9], [1,4,5,7,9,10], [1,6,7,8,9,10], [2,4,6,7,8,10]]
        },
        11: {
            3: [[1,2,3,4,5,6], [1,2,3,7,8,9], [1,2,4,7,10,11], [1,3,5,8,10,11], [1,4,6,8,9,11], [1,5,6,7,9,10], [2,3,6,7,10,11], [2,4,5,8,10,11], [2,6,8,9,10,11], [3,4,5,7,9,11], [3,4,6,8,9,10], [5,6,7,8,10,11]],
            4: [[1,2,3,4,5,6], [1,2,7,8,9,10], [1,3,4,7,8,11], [1,5,6,9,10,11], [1,7,9,10,11,2], [2,4,5,6,8,10], [2,4,7,9,10,11], [3,5,6,7,8,9], [3,6,8,9,10,11], [4,5,7,8,9,10]],
            5: [[1,2,3,4,5,6], [1,2,3,7,8,9], [1,4,5,7,10,11], [1,6,8,9,10,11], [2,4,6,7,9,10], [3,5,6,8,10,11]]
        },
        12: {
            3: [[1,2,3,4,5,6], [1,2,3,7,8,9], [1,2,4,7,10,11], [1,3,5,8,11,12], [1,4,6,9,10,12], [1,5,6,7,8,10], [1,9,10,11,12,2], [2,3,6,8,10,12], [2,4,5,8,9,11], [2,6,7,9,11,12], [3,4,5,7,10,12], [3,4,6,8,9,11], [3,7,9,10,11,12], [4,5,6,7,8,12], [5,6,8,9,10,11]],
            4: [[1,2,3,4,5,6], [1,2,7,8,9,10], [1,3,4,7,11,12], [1,5,6,9,11,12], [1,8,10,11,12,3], [2,4,5,6,8,11], [2,4,7,9,11,12], [2,6,9,10,11,12], [3,5,6,7,9,10], [3,8,9,10,11,12], [4,5,7,8,10,12], [4,6,8,9,10,11]],
            5: [[1,2,3,4,5,6], [1,2,3,7,8,9], [1,4,5,10,11,12], [1,6,7,10,11,12], [2,4,6,8,9,10], [2,5,7,9,11,12], [3,5,6,8,10,11], [3,4,7,8,11,12]]
        },
        13: {
            3: [[1,2,3,4,5,6], [1,2,3,7,8,9], [1,2,4,7,10,11], [1,3,5,8,12,13], [1,4,6,9,11,13], [1,5,7,9,10,12], [1,6,8,10,11,12], [2,3,6,8,11,13], [2,4,5,9,12,13], [2,6,7,10,12,13], [2,8,9,10,11,13], [3,4,5,7,11,12], [3,4,6,9,10,13], [3,7,9,11,12,13], [4,5,6,8,10,13], [4,7,8,9,11,12], [5,6,7,8,11,13], [5,8,9,10,12,13]],
            4: [[1,2,3,4,5,6], [1,2,7,8,9,10], [1,3,4,11,12,13], [1,5,6,9,11,13], [1,7,10,11,12,13], [2,4,5,6,8,12], [2,4,7,10,12,13], [2,6,9,11,12,13], [3,5,7,8,9,11], [3,6,8,10,11,13], [3,9,10,11,12,13], [4,5,7,9,10,11], [4,6,8,9,10,12], [5,7,8,10,12,13]],
            5: [[1,2,3,4,5,6], [1,2,3,7,8,9], [1,4,5,10,12,13], [1,6,7,11,12,13], [2,4,6,8,10,11], [2,5,7,9,11,13], [3,5,6,8,11,12], [3,4,7,9,10,13], [4,8,9,11,12,13]]
        },
        14: {
            3: [[1,2,3,4,5,6], [1,2,3,7,8,9], [1,2,4,7,10,11], [1,3,5,8,13,14], [1,4,6,9,12,14], [1,5,7,10,12,13], [1,6,8,11,12,14], [1,9,10,11,13,14], [2,3,6,9,11,14], [2,4,5,10,13,14], [2,6,7,11,13,14], [2,8,10,11,12,14], [3,4,5,7,12,13], [3,4,6,10,11,13], [3,7,9,12,13,14], [4,5,6,8,11,14], [4,7,8,9,12,13], [5,6,7,9,10,14], [5,8,9,11,12,13], [6,8,9,10,12,13], [7,8,10,11,13,14]],
            4: [[1,2,3,4,5,6], [1,2,7,8,9,10], [1,3,4,11,13,14], [1,5,6,10,12,14], [1,7,9,12,13,14], [1,8,11,12,13,14], [2,4,5,6,9,13], [2,4,7,11,13,14], [2,6,8,10,12,13], [2,9,10,11,12,14], [3,5,7,9,10,12], [3,6,8,9,11,14], [3,10,11,12,13,14], [4,5,7,8,10,11], [4,6,8,9,10,13], [5,7,9,11,13,14], [6,7,10,11,12,13]],
            5: [[1,2,3,4,5,6], [1,2,3,7,8,9], [1,4,5,10,13,14], [1,6,7,11,13,14], [1,9,10,12,13,14], [2,4,6,9,11,12], [2,5,7,10,12,14], [3,5,6,8,12,13], [3,4,7,9,11,13], [4,8,10,11,12,14], [5,8,9,10,11,13]]
        },
        15: {
            3: [[1,2,3,4,5,6], [1,2,3,7,8,9], [1,2,4,7,10,11], [1,3,5,8,14,15], [1,4,6,9,13,15], [1,5,7,11,13,14], [1,6,8,12,13,15], [1,9,10,12,14,15], [1,11,12,13,14,15], [2,3,6,10,12,15], [2,4,5,11,14,15], [2,6,7,12,14,15], [2,8,11,12,13,15], [2,9,10,11,13,14], [3,4,5,7,13,14], [3,4,6,11,12,14], [3,7,9,13,14,15], [3,8,10,11,12,15], [4,5,6,8,12,15], [4,7,8,10,13,14], [5,6,7,10,11,15], [5,8,9,12,13,14], [6,9,10,11,13,14], [7,8,9,11,12,15], [7,9,10,12,13,15], [8,9,10,11,14,15]],
            4: [[1,2,3,4,5,6], [1,2,7,8,9,10], [1,3,4,11,14,15], [1,5,6,11,13,15], [1,7,10,13,14,15], [1,8,9,12,14,15], [1,11,12,13,14,15], [2,4,5,6,10,14], [2,4,7,12,14,15], [2,6,9,11,13,14], [2,8,10,12,13,15], [3,5,7,9,11,13], [3,6,8,10,12,14], [3,9,10,12,13,15], [4,5,7,8,11,12], [4,6,8,9,11,14], [4,9,10,11,13,15], [5,7,10,12,14,15], [5,8,9,10,13,14], [6,7,11,12,13,15], [6,9,10,12,14,15]],
            5: [[1,2,3,4,5,6], [1,2,3,7,8,9], [1,4,5,10,14,15], [1,6,7,12,14,15], [1,9,11,13,14,15], [2,4,6,10,12,13], [2,5,7,11,13,15], [2,8,9,10,11,14], [3,5,6,9,13,14], [3,4,7,10,11,14], [3,8,10,12,13,15], [4,8,9,11,12,15], [5,8,10,11,12,13], [6,9,10,11,12,15]]
        }
    };

    function generateReducedSystem() {
        const numCount = parseInt(document.getElementById('systemNumbers').value);
        const guarantee = parseInt(document.getElementById('systemGuarantee').value);
        const source = document.getElementById('systemSource').value;

        if (!reducedSystems[numCount] || !reducedSystems[numCount][guarantee]) {
            alert('Sistema non disponibile per questa configurazione!');
            return;
        }

        // Genera pool di numeri dalla strategia scelta
        let poolNumbers = [];
        if (source === 'mixed') {
            // Mix intelligente: prendi dai migliori di ogni strategia
            const balanced = generateStrategyResults(analysisData.stats, 'balanced').sestina;
            const hot = generateStrategyResults(analysisData.stats, 'hotNumbers').sestina;
            const cold = generateStrategyResults(analysisData.stats, 'coldNumbers').sestina;

            poolNumbers = [...new Set([...balanced, ...hot, ...cold])];
        } else {
            const result = generateStrategyResults(analysisData.stats, source);
            poolNumbers = [...result.sestina];

            // Aggiungi altri numeri dalla stessa strategia fino a raggiungere numCount
            const allRanked = Object.keys(analysisData.stats.main).slice(1)
                .map(Number)
                .sort((a, b) => {
                    const config = strategies[source];
                    const scoreA = (analysisData.stats.main[a].f * config.freqWeight) +
                        (analysisData.stats.main[a].d * config.delayWeight);
                    const scoreB = (analysisData.stats.main[b].f * config.freqWeight) +
                        (analysisData.stats.main[b].d * config.delayWeight);
                    return scoreB - scoreA;
                });

            for (let num of allRanked) {
                if (!poolNumbers.includes(num)) {
                    poolNumbers.push(num);
                }
                if (poolNumbers.length >= numCount) break;
            }
        }

        poolNumbers = poolNumbers.slice(0, numCount).sort((a, b) => a - b);

        // Genera combinazioni dal sistema ridotto
        const systemTemplate = reducedSystems[numCount][guarantee];
        const combinations = systemTemplate.map(template =>
            template.map(idx => poolNumbers[idx - 1])
        );

        displayReducedSystem(poolNumbers, combinations, guarantee, numCount);
    }

    function displayReducedSystem(pool, combinations, guarantee, numCount) {
        const costPerCombo = 1; // 1‚Ç¨ per combinazione
        const totalCost = combinations.length * costPerCombo;

        let html = `
            <div class="system-summary">
                <h3 style="color: #fbbf24; margin-bottom: 15px; text-align: center;">
                    üìä SISTEMA GENERATO
                </h3>
                <div style="text-align: center; margin: 20px 0;">
                    <div class="guarantee-badge">Garanzia ${guarantee}</div>
                    <p style="color: #94a3b8; margin-top: 10px;">
                        Se tra questi ${numCount} numeri ci sono i 6 vincenti, fai ALMENO un ${guarantee}
                    </p>
                </div>

                <div style="background: #0f172a; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4 style="color: #f8fafc; margin-bottom: 15px; text-align: center;">
                        üéØ I Tuoi ${numCount} Numeri
                    </h4>
                    <div class="balls">
                        ${pool.map(n => `<div class="ball system">${n}</div>`).join('')}
                    </div>
                </div>

                <div class="system-summary-grid">
                    <div class="system-stat">
                        <div class="system-stat-value">${combinations.length}</div>
                        <div class="system-stat-label">Combinazioni</div>
                    </div>
                    <div class="system-stat">
                        <div class="system-stat-value">${totalCost}‚Ç¨</div>
                        <div class="system-stat-label">Costo Totale</div>
                    </div>
                    <div class="system-stat">
                        <div class="system-stat-value">${numCount}</div>
                        <div class="system-stat-label">Numeri Giocati</div>
                    </div>
                    <div class="system-stat">
                        <div class="system-stat-value">${guarantee}</div>
                        <div class="system-stat-label">Premio Garantito</div>
                    </div>
                </div>
            </div>

            <div class="info-box">
                <h4>üí° Come Funziona</h4>
                <p>
                    Questo sistema ridotto copre <strong>${combinations.length} sestine</strong> in modo matematicamente ottimizzato.
                    Se tra i tuoi ${numCount} numeri ci sono tutti e 6 i numeri vincenti,
                    hai la GARANZIA MATEMATICA di fare almeno un <strong>${guarantee}</strong>.
                </p>
                <p style="margin-top: 10px;">
                    Rispetto a giocare tutte le possibili sestine da ${numCount} numeri (che sarebbero ${calculateCombinations(numCount, 6)} combinazioni!),
                    questo sistema ti fa risparmiare <strong>${calculateCombinations(numCount, 6) - combinations.length}</strong> combinazioni
                    mantenendo la garanzia.
                </p>
            </div>

            <h3 style="color: #f8fafc; margin: 30px 0 20px 0; text-align: center;">
                üìã Le Tue ${combinations.length} Sestine da Giocare
            </h3>
            <div style="max-height: 600px; overflow-y: auto; background: #0f172a; padding: 15px; border-radius: 10px;">
                ${combinations.map((combo, idx) => `
                    <div class="combination-row">
                        <span class="combination-label">Sestina ${idx + 1}:</span>
                        ${combo.map(n => `<div class="ball">${n}</div>`).join('')}
                    </div>
                `).join('')}
            </div>

            <div class="info-box" style="margin-top: 30px; background: #1e3a1c; border-left-color: #10b981;">
                <h4 style="color: #10b981;">‚úÖ Cosa Fare Ora</h4>
                <p>
                    1. <strong>Copia queste ${combinations.length} sestine</strong> su un foglio o screenshot<br>
                    2. <strong>Gioca tutte le combinazioni</strong> alla prossima estrazione<br>
                    3. <strong>Costo totale: ${totalCost}‚Ç¨</strong> (${costPerCombo}‚Ç¨ per sestina)<br>
                    4. Se tra i tuoi ${numCount} numeri ci sono i 6 vincenti, sei SICURO di vincere almeno un ${guarantee}!
                </p>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button onclick="printSystem()" style="padding: 12px 30px; background: #10b981; color: white; margin: 0 10px;">
                    üñ®Ô∏è STAMPA SISTEMA
                </button>
                <button onclick="downloadSystem(${JSON.stringify(combinations)})" style="padding: 12px 30px; background: #3b82f6; color: white; margin: 0 10px;">
                    üíæ SCARICA TXT
                </button>
                <button onclick="showSystemsGenerator()" style="padding: 12px 30px; background: #334155; color: #94a3b8; margin: 0 10px;">
                    üîÑ NUOVO SISTEMA
                </button>
            </div>
        `;

        document.getElementById('systemResults').innerHTML = html;
    }

    function calculateCombinations(n, k) {
        let result = 1;
        for (let i = 1; i <= k; i++) {
            result *= (n - k + i) / i;
        }
        return Math.round(result);
    }

    function printSystem() {
        window.print();
    }

    function downloadSystem(combinations) {
        let text = `SISTEMA RIDOTTO SUPERENALOTTO\n`;
        text += '='.repeat(50) + '\n\n';
        text += `Data generazione: ${new Date().toLocaleString('it-IT')}\n`;
        text += `Totale combinazioni: ${combinations.length}\n`;
        text += `Costo totale: ${combinations.length}‚Ç¨\n`;
        text += '\n' + '='.repeat(50) + '\n\n';

        combinations.forEach((combo, idx) => {
            text += `Sestina ${String(idx + 1).padStart(3, '0')}: ${combo.join(', ')}\n`;
        });

        text += '\n' + '='.repeat(50) + '\n';
        text += 'BUONA FORTUNA! üçÄ\n';

        const blob = new Blob([text], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sistema_ridotto_${combinations.length}_sestine.txt`;
        a.click();
    }

    document.getElementById('superBudget').addEventListener('input', function() {
        document.getElementById('superBudgetValue').textContent = this.value + '‚Ç¨';
    });

    function showSuperSystem() {
        if (!analysisData) {
            alert("Prima carica l'archivio e fai un'analisi!");
            return;
        }
        document.getElementById('results').style.display = 'none';
        document.getElementById('systemsPanel').style.display = 'none';
        document.getElementById('superSystemPanel').style.display = 'block';
        window.scrollTo({top: document.getElementById('superSystemPanel').offsetTop - 20, behavior: 'smooth'});
    }

    function generateSuperSystem() {
        const budget = parseInt(document.getElementById('superBudget').value);
        const mode = document.getElementById('superMode').value;

        // Raccogli strategie selezionate
        const selectedStrategies = [];
        if (document.getElementById('includeCaldi').checked) selectedStrategies.push('hotNumbers');
        if (document.getElementById('includeFreddi').checked) selectedStrategies.push('coldNumbers');
        if (document.getElementById('includeBalanced').checked) selectedStrategies.push('balanced');
        if (document.getElementById('includeRecent').checked) selectedStrategies.push('recentFocused');
        if (document.getElementById('includeContrarian').checked) selectedStrategies.push('contrarian');
        if (document.getElementById('includeMath').checked) selectedStrategies.push('mathematical');

        if (selectedStrategies.length < 2) {
            alert('Seleziona almeno 2 strategie per il Super Sistema!');
            return;
        }

        // Genera pool di numeri per ogni strategia
        const pools = {};
        selectedStrategies.forEach(strat => {
            const result = generateStrategyResults(analysisData.stats, strat);
            pools[strat] = {
                name: strategies[strat].name,
                color: strategies[strat].color,
                numbers: result.sestina,
                stars: result.stars
            };
        });

        let finalCombinations = [];
        let poolDescription = '';

        if (mode === 'union') {
            // UNION: prendi tutti i numeri unici da tutte le strategie
            const allNumbers = new Set();
            Object.values(pools).forEach(pool => {
                pool.numbers.forEach(n => allNumbers.add(n));
            });
            const uniqueNumbers = Array.from(allNumbers).sort((a, b) => a - b);

            // Genera combinazioni fino al budget
            const maxCombos = Math.floor(budget);
            finalCombinations = generateSmartCombinations(uniqueNumbers, maxCombos);
            poolDescription = `Pool di ${uniqueNumbers.length} numeri unici da tutte le strategie`;

        } else if (mode === 'intersection') {
            // INTERSECTION: solo numeri che appaiono in almeno 2 strategie
            const numCount = {};
            Object.values(pools).forEach(pool => {
                pool.numbers.forEach(n => {
                    numCount[n] = (numCount[n] || 0) + 1;
                });
            });
            const commonNumbers = Object.keys(numCount)
                .filter(n => numCount[n] >= 2)
                .map(Number)
                .sort((a, b) => a - b);

            if (commonNumbers.length < 6) {
                alert('Non ci sono abbastanza numeri comuni! Prova con Union o Hybrid.');
                return;
            }

            const maxCombos = Math.floor(budget);
            finalCombinations = generateSmartCombinations(commonNumbers, maxCombos);
            poolDescription = `Pool di ${commonNumbers.length} numeri comuni (presenti in 2+ strategie)`;

        } else if (mode === 'hybrid') {
            // HYBRID: 50% union + 50% intersection
            const allNumbers = new Set();
            const numCount = {};

            Object.values(pools).forEach(pool => {
                pool.numbers.forEach(n => {
                    allNumbers.add(n);
                    numCount[n] = (numCount[n] || 0) + 1;
                });
            });

            const commonNumbers = Object.keys(numCount)
                .filter(n => numCount[n] >= 2)
                .map(Number);

            const uniqueNumbers = Array.from(allNumbers);
            const otherNumbers = uniqueNumbers.filter(n => !commonNumbers.includes(n));

            // Prendi 50% comuni + 50% altri
            const targetSize = Math.min(15, Math.ceil(uniqueNumbers.length * 0.8));
            const hybridPool = [
                ...commonNumbers.slice(0, Math.ceil(targetSize / 2)),
                ...otherNumbers.slice(0, Math.floor(targetSize / 2))
            ].sort((a, b) => a - b);

            const maxCombos = Math.floor(budget);
            finalCombinations = generateSmartCombinations(hybridPool, maxCombos);
            poolDescription = `Pool ibrido di ${hybridPool.length} numeri (50% comuni + 50% unici)`;

        } else if (mode === 'megasystem') {
            // MEGASYSTEM: tutte le sestine di tutte le strategie (rimozione duplicati)
            const allCombos = new Set();
            Object.values(pools).forEach(pool => {
                const comboKey = pool.numbers.sort((a,b) => a-b).join(',');
                allCombos.add(comboKey);
            });

            finalCombinations = Array.from(allCombos).map(combo =>
                combo.split(',').map(Number)
            );

            // Se supera il budget, prendi le prime N
            if (finalCombinations.length > budget) {
                finalCombinations = finalCombinations.slice(0, budget);
            }

            poolDescription = `Tutte le sestine delle strategie selezionate (duplicati rimossi)`;
        }

        displaySuperSystem(pools, finalCombinations, budget, mode, poolDescription, selectedStrategies);
    }

    function generateSmartCombinations(pool, maxCount) {
        if (pool.length < 6) return [];

        const combinations = [];
        const poolSize = pool.length;

        if (poolSize === 6) {
            return [pool];
        }

        if (poolSize <= 12) {
            // Sistema ridotto per pool piccoli
            const systemSize = Math.min(poolSize, 10);
            const guarantee = poolSize >= 10 ? 4 : 3;

            if (reducedSystems[systemSize] && reducedSystems[systemSize][guarantee]) {
                const template = reducedSystems[systemSize][guarantee];
                template.forEach(t => {
                    combinations.push(t.map(idx => pool[idx - 1]));
                });
            }
        }

        // Se non abbiamo abbastanza combinazioni, genera casualmente
        while (combinations.length < maxCount && combinations.length < 100) {
            const combo = [];
            const used = new Set();

            while (combo.length < 6) {
                const idx = Math.floor(Math.random() * pool.length);
                const num = pool[idx];
                if (!used.has(num)) {
                    combo.push(num);
                    used.add(num);
                }
            }

            const comboKey = combo.sort((a,b) => a-b).join(',');
            if (!combinations.some(c => c.join(',') === comboKey)) {
                combinations.push(combo.sort((a,b) => a-b));
            }
        }

        return combinations.slice(0, maxCount);
    }

    function displaySuperSystem(pools, combinations, budget, mode, description, strategies) {
        const actualCost = combinations.length;
        const savings = budget - actualCost;

        let html = `
            <div class="mega-stat">
                <div class="mega-stat-value">${combinations.length}</div>
                <div class="mega-stat-label">Sestine Generate</div>
            </div>

            <div class="super-system-card">
                <h3 style="color: #a855f7; margin-bottom: 20px; text-align: center;">
                    üìä ANALISI SUPER SISTEMA
                </h3>

                <table class="comparison-table">
                    <tr>
                        <th>Metrica</th>
                        <th>Valore</th>
                    </tr>
                    <tr>
                        <td><strong>Modalit√†</strong></td>
                        <td style="color: #a855f7;">${mode.toUpperCase()}</td>
                    </tr>
                    <tr>
                        <td><strong>Strategie Combinate</strong></td>
                        <td>${strategies.length}</td>
                    </tr>
                    <tr>
                        <td><strong>Descrizione Pool</strong></td>
                        <td>${description}</td>
                    </tr>
                    <tr>
                        <td><strong>Budget Previsto</strong></td>
                        <td>${budget}‚Ç¨</td>
                    </tr>
                    <tr>
                        <td><strong>Costo Effettivo</strong></td>
                        <td style="color: #10b981; font-weight: bold;">${actualCost}‚Ç¨</td>
                    </tr>
                    <tr>
                        <td><strong>Risparmio</strong></td>
                        <td style="color: ${savings > 0 ? '#10b981' : '#ef4444'};">${savings}‚Ç¨</td>
                    </tr>
                </table>
            </div>

            <div class="strategy-pool">
                ${Object.entries(pools).map(([key, pool]) => `
                    <div class="strategy-pool-card" style="border-left-color: ${pool.color};">
                        <h4 style="color: ${pool.color}; margin-bottom: 10px;">${pool.name}</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${pool.numbers.map(n =>
            `<span style="background: ${pool.color}; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold;">${n}</span>`
        ).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>

            <div class="info-box" style="background: #1e3a1c; border-left-color: #10b981;">
                <h4 style="color: #10b981;">üí° Come Funziona Questo Super Sistema</h4>
                <p>
                    ${getModeExplanation(mode, strategies.length)}
                </p>
            </div>

            ${actualCost > 50 ? `
                <div class="warning-box">
                    <h4>‚ö†Ô∏è ATTENZIONE - Sistema Costoso</h4>
                    <p>
                        Questo sistema costa <strong>${actualCost}‚Ç¨</strong>. Assicurati che sia compatibile con il tuo budget per il gioco responsabile.
                        Ricorda: anche con tante combinazioni, la probabilit√† di vincita rimane molto bassa.
                    </p>
                </div>
            ` : ''}

            <h3 style="color: #a855f7; margin: 30px 0 20px 0; text-align: center;">
                üé≤ Le Tue ${combinations.length} Sestine Super Sistema
            </h3>
            <div style="max-height: 600px; overflow-y: auto; background: #0f172a; padding: 15px; border-radius: 10px; border: 2px solid #a855f7;">
                ${combinations.map((combo, idx) => `
                    <div class="combination-row">
                        <span class="combination-label">Sestina ${idx + 1}:</span>
                        ${combo.map(n => `<div class="ball" style="background: #a855f7;">${n}</div>`).join('')}
                    </div>
                `).join('')}
            </div>

            <div style="text-align: center; margin-top: 35px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button onclick="printSystem()" style="padding: 15px 30px; background: #10b981; color: white; border-radius: 10px; border: 2px solid #059669;">
                    üñ®Ô∏è STAMPA SUPER SISTEMA
                </button>
                <button onclick="downloadSuperSystem(${JSON.stringify(combinations)}, '${mode}')" style="padding: 15px 30px; background: #3b82f6; color: white; border-radius: 10px; border: 2px solid #2563eb;">
                    üíæ SCARICA TXT
                </button>
                <button onclick="compareWithSingleSystems()" style="padding: 15px 30px; background: #f59e0b; color: white; border-radius: 10px; border: 2px solid #d97706;">
                    üìä CONFRONTA
                </button>
                <button onclick="showSuperSystem()" style="padding: 15px 30px; background: #334155; color: #94a3b8; border-radius: 10px; border: 2px solid #475569;">
                    üîÑ NUOVO SUPER SISTEMA
                </button>
            </div>

            <div class="info-box" style="margin-top: 30px;">
                <h4>üéØ Prossimi Passi</h4>
                <p>
                    1. <strong>Scarica o stampa</strong> tutte le ${combinations.length} sestine<br>
                    2. <strong>Gioca l'intero sistema</strong> alla prossima estrazione<br>
                    3. <strong>Tieni traccia</strong> dei risultati per confronto<br>
                    4. <strong>Divertiti!</strong> Ricorda che √® un gioco, non un investimento
                </p>
            </div>
        `;

        document.getElementById('superSystemResults').innerHTML = html;
    }

    function getModeExplanation(mode, stratCount) {
        const explanations = {
            union: `Questo Super Sistema UNION combina <strong>${stratCount} diverse strategie</strong> prendendo i numeri migliori da ognuna.
                   Risultato: massima diversificazione e copertura di tutte le filosofie di gioco.`,

            intersection: `Questo Super Sistema INTERSECTION si concentra sui <strong>numeri comuni</strong> tra le ${stratCount} strategie.
                          Solo i numeri che appaiono in almeno 2 strategie vengono inclusi. Risultato: concentrazione sui "favoriti condivisi".`,

            hybrid: `Questo Super Sistema HYBRID √® un <strong>mix perfetto</strong> tra Union e Intersection.
                    Include sia i numeri comuni che alcuni numeri unici da ogni strategia. Risultato: equilibrio tra concentrazione e diversificazione.`,

            megasystem: `Questo MEGASYSTEM gioca <strong>TUTTE le sestine</strong> generate dalle ${stratCount} strategie selezionate.
                        I duplicati sono stati rimossi automaticamente. Risultato: copertura totale di tutte le combinazioni top.`
        };

        return explanations[mode] || 'Sistema ottimizzato per massima copertura.';
    }

    function downloadSuperSystem(combinations, mode) {
        let text = `SUPER SISTEMA SUPERENALOTTO - Modalit√† ${mode.toUpperCase()}\n`;
        text += '='.repeat(60) + '\n\n';
        text += `Data generazione: ${new Date().toLocaleString('it-IT')}\n`;
        text += `Totale combinazioni: ${combinations.length}\n`;
        text += `Costo totale: ${combinations.length}‚Ç¨\n`;
        text += '\n' + '='.repeat(60) + '\n\n';

        combinations.forEach((combo, idx) => {
            text += `Sestina ${String(idx + 1).padStart(3, '0')}: ${combo.join(', ')}\n`;
        });

        text += '\n' + '='.repeat(60) + '\n';
        text += 'BUONA FORTUNA! üçÄ\n';

        const blob = new Blob([text], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `super_sistema_${mode}_${combinations.length}_sestine.txt`;
        a.click();
    }

    function compareWithSingleSystems() {
        alert('Funzione di confronto in sviluppo! Confronter√† il Super Sistema con le singole strategie.');
    }

    function selectStrategy(strategy) {
        currentStrategy = strategy;
        document.querySelectorAll('.strategy-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.closest('.strategy-btn').classList.add('active');

        if (analysisData) displayResults();
    }

    // ===============================
    // GESTIONE AGGIORNAMENTI LIVE
    // ===============================
    function addNewExtraction() {
        const input = document.getElementById('newExtraction').value.trim();
        if (!input) return alert("Inserisci i numeri dell'estrazione");

        const numbers = input.match(/\d+/g);
        if (!numbers || numbers.length < 6) {
            return alert("Formato non valido. Inserisci almeno 6 numeri");
        }

        const nums = numbers.map(Number).filter(n => n >= 1 && n <= 90);
        const uniqueNums = [...new Set(nums)].slice(0, 6);

        if (uniqueNums.length < 6) {
            return alert("Numeri insufficienti o non validi");
        }

        const currentData = document.getElementById('dataInput').value.trim();
        const newLine = uniqueNums.join(',') + (numbers[6] ? `,${numbers[6]}` : '');
        document.getElementById('dataInput').value = newLine + '\n' + currentData;

        recentExtractions.unshift({
            numbers: uniqueNums,
            timestamp: new Date().toLocaleTimeString()
        });

        recentExtractions = recentExtractions.slice(0, 5);

        document.getElementById('newExtraction').value = '';
        document.getElementById('validationInfo').innerHTML =
            `<div class="validation-info">‚úÖ Estrazione aggiunta: ${uniqueNums.join(', ')}</div>`;

        setTimeout(() => analyzeAllStrategies(), 300);
    }

    // ===============================
    // ANALISI CON PESO RECENTE
    // ===============================
    function analyzeAllStrategies() {
        const raw = document.getElementById('dataInput').value.trim();
        if (!raw) return alert("ERRORE: Nessun dato da analizzare.");

        document.getElementById('loading').style.display = 'block';
        document.getElementById('results').style.display = 'none';

        setTimeout(() => {
            try {
                analysisData = performDynamicAnalysis(raw);
                displayResults();
            } catch (error) {
                alert("Errore nell'analisi: " + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }, 100);
    }

    function performDynamicAnalysis(rawData) {
        const lines = rawData.trim().split('\n').filter(line => line.trim());
        const totalLines = lines.length;

        const recentLines = lines.slice(0, Math.min(10, totalLines));

        const stats = {
            main: Array.from({length: 91}, () => ({
                f: 0,
                d: totalLines,
                recentF: 0
            })),
            star: Array.from({length: 91}, () => ({
                f: 0,
                d: totalLines,
                recentF: 0
            })),
            totalExtractions: totalLines,
            recentExtractions: recentLines.length
        };

        lines.forEach((line, idx) => {
            const numbers = (line.match(/\d+/g) || []).map(Number);
            const isRecent = idx < recentLines.length;

            if (numbers.length >= 6) {
                numbers.slice(0, 6).forEach(n => {
                    if (n >= 1 && n <= 90) {
                        stats.main[n].f++;
                        stats.main[n].d = Math.min(stats.main[n].d, totalLines - 1 - idx);
                        if (isRecent) stats.main[n].recentF++;
                    }
                });
            }

            if (numbers.length >= 7) {
                const lastNum = numbers[numbers.length - 1];
                if (lastNum >= 1 && lastNum <= 90) {
                    stats.star[lastNum].f++;
                    stats.star[lastNum].d = Math.min(stats.star[lastNum].d, totalLines - 1 - idx);
                    if (isRecent) stats.star[lastNum].recentF++;
                }
            }
        });

        return {
            stats: stats,
            linesProcessed: totalLines,
            recentCount: recentLines.length
        };
    }

    function generateStrategyResults(stats, strategy) {
        const config = strategies[strategy];

        // STRATEGIA MATEMATICA - Distribuzione uniforme
        if (config.special === 'spread') {
            return generateSpreadStrategy(stats, config);
        }

        // STRATEGIA CONTRARIAN - Inverte la logica
        if (config.inverted) {
            return generateContrianStrategy(stats, config);
        }

        // Calcolo punteggio standard con PESO RECENTE
        let rankedMain = Object.keys(stats.main).slice(1)
            .map(Number)
            .sort((a, b) => {
                const baseScoreA = (stats.main[a].f * config.freqWeight) +
                    (stats.main[a].d * config.delayWeight);
                const recentScoreA = stats.main[a].recentF * config.recentWeight * 10;

                const baseScoreB = (stats.main[b].f * config.freqWeight) +
                    (stats.main[b].d * config.delayWeight);
                const recentScoreB = stats.main[b].recentF * config.recentWeight * 10;

                return (baseScoreB + recentScoreB) - (baseScoreA + recentScoreA);
            });

        const sestina = rankedMain.slice(0, 6).sort((a, b) => a - b);

        const rankedStar = Object.keys(stats.star).slice(1)
            .map(Number)
            .sort((a, b) => {
                const baseScoreA = (stats.star[a].f * config.freqWeight) +
                    (stats.star[a].d * config.delayWeight);
                const recentScoreA = stats.star[a].recentF * config.recentWeight * 10;

                const baseScoreB = (stats.star[b].f * config.freqWeight) +
                    (stats.star[b].d * config.delayWeight);
                const recentScoreB = stats.star[b].recentF * config.recentWeight * 10;

                return (baseScoreB + recentScoreB) - (baseScoreA + recentScoreA);
            })
            .slice(0, 3);

        return {
            sestina: sestina,
            stars: rankedStar,
            delays: Object.keys(stats.main).slice(1)
                .map(Number)
                .sort((a, b) => stats.main[b].d - stats.main[a].d)
                .slice(0, 5)
        };
    }

    // Strategia distribuzione uniforme
    function generateSpreadStrategy(stats, config) {
        // Divide il range 1-90 in 6 zone
        const zones = [
            [1, 15],   // Zona 1
            [16, 30],  // Zona 2
            [31, 45],  // Zona 3
            [46, 60],  // Zona 4
            [61, 75],  // Zona 5
            [76, 90]   // Zona 6
        ];

        const sestina = [];
        zones.forEach(([min, max]) => {
            // Prendi il miglior numero di ogni zona
            const zoneNumbers = Object.keys(stats.main).slice(min, max + 1)
                .map(Number)
                .sort((a, b) => {
                    const scoreA = (stats.main[a].f * config.freqWeight) +
                        (stats.main[a].d * config.delayWeight);
                    const scoreB = (stats.main[b].f * config.freqWeight) +
                        (stats.main[b].d * config.delayWeight);
                    return scoreB - scoreA;
                });
            if (zoneNumbers[0]) sestina.push(zoneNumbers[0]);
        });

        const rankedStar = Object.keys(stats.star).slice(1)
            .map(Number)
            .sort((a, b) => stats.star[b].f - stats.star[a].f)
            .slice(0, 3);

        return {
            sestina: sestina.sort((a, b) => a - b),
            stars: rankedStar,
            delays: []
        };
    }

    // Strategia contrarian - evita i pi√π popolari
    function generateContrianStrategy(stats, config) {
        let rankedMain = Object.keys(stats.main).slice(1)
            .map(Number)
            .sort((a, b) => {
                // Penalizza i frequenti, premia i ritardatari
                const scoreA = (-stats.main[a].f * 0.3) + (stats.main[a].d * 0.7);
                const scoreB = (-stats.main[b].f * 0.3) + (stats.main[b].d * 0.7);
                return scoreB - scoreA;
            });

        // Evita anche i numeri "ovvi" come multipli di 5 e numeri sotto 31
        rankedMain = rankedMain.filter(n => {
            const isMultipleOf5 = n % 5 === 0;
            const isDateNumber = n <= 31;
            const isVeryFrequent = stats.main[n].f > stats.totalExtractions * 0.015;
            return !(isMultipleOf5 || (isDateNumber && isVeryFrequent));
        });

        const sestina = rankedMain.slice(0, 6).sort((a, b) => a - b);

        const rankedStar = Object.keys(stats.star).slice(1)
            .map(Number)
            .filter(n => stats.star[n].f < stats.totalExtractions * 0.01)
            .sort((a, b) => stats.star[b].d - stats.star[a].d)
            .slice(0, 3);

        return {
            sestina: sestina,
            stars: rankedStar.length > 0 ? rankedStar : [45, 67, 89],
            delays: []
        };
    }

    function displayResults() {
        if (!analysisData) return;

        document.getElementById('results').style.display = 'block';

        let updateInfo = '';
        if (previousResults) {
            const changes = compareResults(previousResults, analysisData);
            updateInfo = `<div class="validation-info">${changes}</div>`;
        }
        document.getElementById('updateInfo').innerHTML = updateInfo;

        let resultsHTML = '';

        Object.keys(strategies).forEach(strategyKey => {
            const strategy = strategies[strategyKey];
            const result = generateStrategyResults(analysisData.stats, strategyKey);
            const isUpdated = checkForUpdates(strategyKey, result);

            resultsHTML += `
                <div class="strategy-section ${isUpdated ? 'updated' : ''}" style="border-left: 4px solid ${strategy.color}">
                    <div class="strategy-header">
                        <div>
                            <div class="strategy-title">${strategy.name} ${isUpdated ? 'üîÑ' : ''}</div>
                            <div class="strategy-desc">
                                Estraz. recenti: ${analysisData.recentCount}/${analysisData.linesProcessed}
                                (Peso: ${Math.round(strategy.recentWeight * 100)}%)
                            </div>
                        </div>
                    </div>

                    <div class="label">Sestina Suggerita</div>
                    <div class="balls">
                        ${result.sestina.map((n, index) => {
                const isNew = isUpdated && index < 2;
                return `<div class="ball ${isNew ? 'new' : ''}" style="background: ${strategy.color}">
                                ${n}
                                ${isNew ? '<div class="recency-badge">N</div>' : ''}
                            </div>`;
            }).join('')}
                    </div>

                    <div class="label">SuperStar Consigliati</div>
                    <div class="balls">
                        ${result.stars.map((n, i) =>
                `<div class="ball star" style="animation-delay: ${i * 0.3}s">${n}</div>`
            ).join('')}
                    </div>

                    <div class="comparison">
                        <strong>Analisi Estrazioni Recenti:</strong><br>
                        ‚Ä¢ Numeri nelle ultime estrazioni: ${getRecentNumbersInfo(result.sestina)}<br>
                        ‚Ä¢ SuperStar recenti: ${getRecentNumbersInfo(result.stars)}
                    </div>
                </div>
            `;
        });

        document.getElementById('strategyResults').innerHTML = resultsHTML;

        previousResults = {...analysisData};

        document.getElementById('log').innerHTML =
            `> ESTRAZIONI TOTALI: ${analysisData.linesProcessed}<br>` +
            `> ESTRAZIONI RECENTI: ${analysisData.recentCount}<br>` +
            `> ULTIME AGGIUNTE: ${recentExtractions.length}`;
    }

    function compareResults(oldData, newData) {
        if (!oldData) return "üÜï Analisi iniziale completata";

        const changes = [];
        if (newData.linesProcessed > oldData.linesProcessed) {
            changes.push(`+${newData.linesProcessed - oldData.linesProcessed} nuove estrazioni`);
        }
        if (newData.recentCount > oldData.recentCount) {
            changes.push(`+${newData.recentCount - oldData.recentCount} estrazioni recenti`);
        }

        return changes.length > 0 ?
            `üîÑ Aggiornamento: ${changes.join(', ')}` :
            "üìä Dati invariati - stessi risultati";
    }

    function checkForUpdates(strategyKey, newResult) {
        return recentExtractions.length > 0 || !previousResults;
    }

    function getRecentNumbersInfo(numbers) {
        const recentNumbers = recentExtractions.flatMap(ext => ext.numbers);
        const matches = numbers.filter(n => recentNumbers.includes(n));
        return matches.length > 0 ? matches.join(', ') : 'nessuno';
    }

    function clearData() {
        document.getElementById('dataInput').value = '';
        document.getElementById('newExtraction').value = '';
        document.getElementById('results').style.display = 'none';
        document.getElementById('validationInfo').innerHTML = '';
        document.getElementById('strategyResults').innerHTML = '';
        document.getElementById('updateInfo').innerHTML = '';
        analysisData = null;
        previousResults = null;
        recentExtractions = [];
        localStorage.removeItem('lastArchive');
    }

    const fileInput = document.getElementById('fileInput');
    fileInput.addEventListener('change', handleFileUpload);

    function handleFileUpload(e) {
        const file = e.target.files[0];
        const reader = new FileReader();

        reader.onload = function(ev) {
            const validation = validateData(ev.target.result);

            if (validation.valid) {
                document.getElementById('dataInput').value = validation.data;
                document.getElementById('validationInfo').innerHTML =
                    `<div class="validation-info">‚úì File caricato: ${validation.validLines} righe valide</div>`;

                localStorage.setItem('lastArchive', validation.data);
                recentExtractions = [];
            } else {
                document.getElementById('validationInfo').innerHTML =
                    `<div class="validation-error">‚úó Errore: ${validation.error}</div>`;
            }
        };

        reader.readAsText(file);
    }

    function validateData(rawData) {
        const lines = rawData.trim().split('\n');
        let validLines = 0;
        let processedData = '';

        for (let line of lines) {
            const cleanLine = line.trim();
            if (!cleanLine) continue;

            const numbers = cleanLine.match(/\d+/g);
            if (!numbers || numbers.length < 6) continue;

            const nums = numbers.map(Number).filter(n => n >= 1 && n <= 90);

            const uniqueNums = [];
            const seen = new Set();
            for (const num of nums) {
                if (!seen.has(num)) {
                    seen.add(num);
                    uniqueNums.push(num);
                }
                if (uniqueNums.length >= 6) break;
            }

            if (uniqueNums.length === 6) {
                processedData += uniqueNums.join(',') + '\n';
                validLines++;
            }
        }

        return {
            valid: validLines > 0,
            data: processedData,
            validLines: validLines,
            error: validLines === 0 ? 'Nessuna riga valida trovata' : null
        };
    }

    document.addEventListener('DOMContentLoaded', function() {
        const lastArchive = localStorage.getItem('lastArchive');
        if (lastArchive) {
            document.getElementById('dataInput').value = lastArchive;
            document.getElementById('validationInfo').innerHTML =
                '<div class="validation-info">‚úì Archivio precedente caricato</div>';
        }
    });
</script>
</body>
</html>